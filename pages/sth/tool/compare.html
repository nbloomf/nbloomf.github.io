<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>nbloomf.github.io - Software Tools in Haskell: compare</title>
<link rel="stylesheet" type="text/css" href="../../../css/default.css" />
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>

<body>
<div id="header">
  <div id="logo">
    <a href="../../../index.html">nbloomf</a>
  </div>
  <div id="navigation">
    <a href="../../../index.html">Home</a>
    <a href="../../../about.html">About</a>
    <a href="../../../contact.html">Contact</a>
    <a href="../../../archive.html">Posts</a>
  </div>
</div>

<div id="content">
<h1>Software Tools in Haskell: compare</h1>
<!-- BEGIN BODY -->
<div class="subtitle">
<h2>find the first position where two text streams differ</h2>
This page is part of a series on <a href="../../../pages/sth/index.html">Software Tools in Haskell</a>.
</div>

<p>The purpose of <code>compare</code> is to detect whether or not two streams of text are byte-for-byte identical. This alone is simple enough, but the job is complicated by the fact that (1) there are a few useful places these text streams might come from and (2) in the (typical) case that the streams are <em>not</em> identical, we want to report the position of the first difference.</p>
<p>The <code>diffList</code> function takes two lists and returns the position of the earliest difference as well as the differing elements (if they exist).</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">diffList ::</span> (<span class="dt">Eq</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> (<span class="dt">Maybe</span> a, <span class="dt">Maybe</span> a, <span class="dt">Integer</span>)
diffList <span class="fu">=</span> comp <span class="dv">1</span>
  <span class="kw">where</span>
    comp _ []     []     <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dv">0</span>)
    comp k []     (y<span class="fu">:</span>_)  <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Just</span> y, k)
    comp k (x<span class="fu">:</span>_)  []     <span class="fu">=</span> (<span class="dt">Just</span> x, <span class="dt">Nothing</span>, k)
    comp k (x<span class="fu">:</span>xs) (y<span class="fu">:</span>ys) <span class="fu">=</span> <span class="kw">if</span> x <span class="fu">==</span> y
      <span class="kw">then</span> comp (k<span class="fu">+</span><span class="dv">1</span>) xs ys
      <span class="kw">else</span> (<span class="dt">Just</span> x, <span class="dt">Just</span> y, k)</code></pre></div>
<p>This isn’t quite what we want, though. The problem is that word “position”. The most useful <em>position</em> information will depend on what kind of text is being compared. For instance, when comparing line text we’d like to report the line and column numbers of the earliest difference, rather than just the character index. The <code>diffLists</code> function does this.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">diffLists ::</span> (<span class="dt">Eq</span> a) <span class="ot">=&gt;</span> [[a]] <span class="ot">-&gt;</span> [[a]]
  <span class="ot">-&gt;</span> (<span class="dt">Maybe</span> [a], <span class="dt">Maybe</span> [a], <span class="dt">Integer</span>, <span class="dt">Integer</span>)
diffLists <span class="fu">=</span> comp <span class="dv">1</span>
  <span class="kw">where</span>
    comp _ []       []       <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dv">0</span>, <span class="dv">0</span>)
    comp m []       (ys<span class="fu">:</span>yss) <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Just</span> ys, m, <span class="dv">1</span>)
    comp m (xs<span class="fu">:</span>xss) []       <span class="fu">=</span> (<span class="dt">Just</span> xs, <span class="dt">Nothing</span>, m, <span class="dv">1</span>)
    comp m (xs<span class="fu">:</span>xss) (ys<span class="fu">:</span>yss) <span class="fu">=</span> <span class="kw">case</span> diffList xs ys <span class="kw">of</span>
      (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, _) <span class="ot">-&gt;</span> comp (m<span class="fu">+</span><span class="dv">1</span>) xss yss
      (_,_,n) <span class="ot">-&gt;</span> (<span class="dt">Just</span> xs, <span class="dt">Just</span> ys, m, n)</code></pre></div>
<p>Like we did with <code>echo</code>, we’ll allow the user to specify which kind of position they mean with a <code>--char</code> option (default is line). Now the streams to be compared (of which we need two) can come from one of three places:</p>
<ol style="list-style-type: decimal">
<li><code>stdin</code>,</li>
<li>a file (one or two), or</li>
<li>command line arguments (interpreted like <code>echo</code>).</li>
</ol>
<p>The main program first reads the arguments and extracts (1) the mode (char or line) of text being compared, (2) the name and contents of the first stream to be compared, and (3) the name and contents of the second stream to be compared. Then we evaluate either <code>diffList</code> or <code>diffLists</code> and report the results.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- compare: find the first position where two text streams differ</span>

<span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">System.Exit</span> (exitSuccess, exitFailure)
<span class="kw">import </span><span class="dt">System.Environment</span> (getArgs)
<span class="kw">import </span><span class="dt">Data.Maybe</span> (maybeToList)
<span class="kw">import </span><span class="dt">STH.Lib</span>
  (reportErrorMsgs, getLines, bsUnEsc,
   padToLongerWith, diffList, diffLists, fromLines)


<span class="kw">data</span> <span class="dt">Mode</span> <span class="fu">=</span> <span class="dt">Chars</span> <span class="fu">|</span> <span class="dt">Lines</span>


<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  args <span class="ot">&lt;-</span> getArgs

  <span class="co">-- interpret arguments</span>
  (mode,(name1,stream1),(name2,stream2)) <span class="ot">&lt;-</span> <span class="kw">do</span>
    <span class="kw">let</span>
      (flag,rest) <span class="fu">=</span> <span class="kw">case</span> args <span class="kw">of</span>
        (<span class="st">&quot;--char&quot;</span><span class="fu">:</span>xss) <span class="ot">-&gt;</span> (<span class="dt">Chars</span>,xss)
        xss            <span class="ot">-&gt;</span> (<span class="dt">Lines</span>,xss)

    <span class="kw">case</span> rest <span class="kw">of</span>
      (<span class="st">&quot;--to&quot;</span><span class="fu">:</span>ys) <span class="ot">-&gt;</span> <span class="kw">do</span>
        <span class="kw">let</span>
          as <span class="fu">=</span> bsUnEsc <span class="fu">$</span> <span class="kw">case</span> flag <span class="kw">of</span>
            <span class="dt">Chars</span> <span class="ot">-&gt;</span> concat ys
            <span class="dt">Lines</span> <span class="ot">-&gt;</span> fromLines ys
        bs <span class="ot">&lt;-</span> getContents
        return (flag,(<span class="st">&quot;args&quot;</span>,as),(<span class="st">&quot;stdin&quot;</span>,bs))
      [xs] <span class="ot">-&gt;</span> <span class="kw">do</span>
        as <span class="ot">&lt;-</span> readFile xs
        bs <span class="ot">&lt;-</span> getContents
        return (flag,(xs,as),(<span class="st">&quot;stdin&quot;</span>,bs))
      [xs,ys] <span class="ot">-&gt;</span> <span class="kw">do</span>
        as <span class="ot">&lt;-</span> readFile xs
        bs <span class="ot">&lt;-</span> readFile ys
        return (flag,(xs,as),(ys,bs))
      otherwise <span class="ot">-&gt;</span> argError <span class="fu">&gt;&gt;</span> exitFailure


  <span class="co">-- Some helpers</span>
  <span class="kw">let</span>
    (label1,label2) <span class="fu">=</span> padToLongerWith <span class="ch">' '</span> name1 name2

    report label [] <span class="fu">=</span> putStrLn <span class="fu">$</span> label <span class="fu">++</span> <span class="st">&quot;: (empty)&quot;</span>
    report label xs <span class="fu">=</span> putStrLn <span class="fu">$</span> label <span class="fu">++</span> <span class="st">&quot;: &quot;</span> <span class="fu">++</span> xs


  <span class="kw">case</span> mode <span class="kw">of</span>
    <span class="dt">Chars</span> <span class="ot">-&gt;</span> <span class="kw">case</span> diffList stream1 stream2 <span class="kw">of</span>
      (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, _) <span class="ot">-&gt;</span> return ()
      (x, y, t) <span class="ot">-&gt;</span> <span class="kw">do</span>
        putStrLn <span class="fu">$</span> <span class="st">&quot;first differ at column &quot;</span> <span class="fu">++</span> show t
        report label1 (maybeToList x)
        report label2 (maybeToList y)

    <span class="dt">Lines</span> <span class="ot">-&gt;</span> <span class="kw">case</span> diffLists (getLines stream1) (getLines stream2) <span class="kw">of</span>
      (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, _, _) <span class="ot">-&gt;</span> return ()
      (x, y, m, n) <span class="ot">-&gt;</span> <span class="kw">do</span>
        putStrLn <span class="fu">$</span> <span class="st">&quot;first differ at line &quot;</span> <span class="fu">++</span> show m <span class="fu">++</span> <span class="st">&quot;, column &quot;</span> <span class="fu">++</span> show n
        report label1 (concat <span class="fu">$</span> maybeToList x)
        report label2 (concat <span class="fu">$</span> maybeToList y) 

  exitSuccess


<span class="ot">argError ::</span> <span class="dt">IO</span> ()
argError <span class="fu">=</span> <span class="kw">do</span>
  reportErrorMsgs
    [ <span class="st">&quot;usage:&quot;</span>
    , <span class="st">&quot;  compare FILE1 FILE2  -- find first discrepancy between FILE1 and FILE2&quot;</span>
    , <span class="st">&quot;  compare FILE         -- find first discrepancy between FILE and stdin&quot;</span>
    , <span class="st">&quot;  compare --to STR ... -- find first discrepancy between STRs and stdin&quot;</span>
    , <span class="st">&quot;options:&quot;</span>
    , <span class="st">&quot;  --char : compare as (unlined) character streams&quot;</span>
    ]</code></pre></div>
<p><code>compare</code> can be used to implement a very simple testing scheme by comparing the output of some program under development to its “expected” output. One improvement I can think of is to have <code>compare</code> optionally output delimited data, to make it easier to extract this information with other tools.</p>
<!-- END BODY -->
</div>

<div id="footer">
  Site generated by
  <a href="http://jaspervdj.be/hakyll">Hakyll</a>
</div>
</body>
</html>
