<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>nbloomf.blog - Software Tools in Haskell: pslineprint</title>
<link rel="stylesheet" type="text/css" href="../../css/default.css" />
<link rel="icon" href="../../raw/gfx/icon/favicon-32.png" />
<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../raw/gfx/icon/favicon-57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../raw/gfx/icon/favicon-114.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../raw/gfx/icon/favicon-152.png" />
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>

<body>
<div id="header">
  <div id="logo">
    <a href="../../index.html">nbloomf</a>
  </div>
  <div id="navigation">
    <a href="../../index.html">Home</a>
    <a href="../../pages/about.html">About</a>
    <a href="../../pages/projects.html">Projects</a>
    <a href="../../archive.html">Blog</a>
  </div>
</div>

<div id="content">
<h1>Software Tools in Haskell: pslineprint</h1>
<!-- BEGIN BODY -->
<h2>print lines to postscript</h2>

<div class="info">
Posted on 2016-03-05 by nbloomf
</div>


<div class="info tags">Tags: <a href="../../tag/software-tools-in-haskell.html">software-tools-in-haskell</a>, <a href="../../tag/literate-haskell.html">literate-haskell</a></div>


<p class="post-info">This page is part of a series on <a href="../../pages/sth/index.html">Software Tools in Haskell</a>.</p>

<p class="post-info">This post is literate Haskell; you can load <a href="https://raw.githubusercontent.com/nbloomf/nbloomf.md/master/posts/software-tools-in-haskell/pslineprint.lhs">the source</a> into GHCi and play along.</p>

<hr />

<p>As usual, we start with some imports.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">-- pslineprint: print stdin to postscript</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">import</span> <span class="dt">System.Console.GetOpt</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">import</span> <span class="dt">System.Environment</span> (getArgs, getProgName)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">import</span> <span class="dt">System.Exit</span> (exitSuccess, exitFailure)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">import</span> <span class="dt">System.IO</span> (hPutStrLn, stderr)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Control.Applicative</span> (<span class="dt">Applicative</span>(..))</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Monad</span> (liftM, ap)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Data.List</span> (unfoldr, isPrefixOf)</a></code></pre></div>
<p>We will separate the <code>print</code> example program in <em>Software Tools</em> into several utilities. I don’t have access to a real line printer (are these even made anymore? I can’t find any info) so I’ll start by building a “virtual” line printer. A line printer consumes lines of text and prints them onto paper one by one. Our virtual line printer should do the same, or something like it – consume lines of text and convert them to a format that can be sent to a real printer.</p>
<p><em>PostScript</em> is a programming language, in use since the mid-1980s, which allows us to succinctly describe the appearance of a printed page. Many printers can directly interpret programs written in PostScript and there is a large ecosystem of tools which can manipulate PostScript documents. The language is a de facto standard, and so we choose PostScript as the output format of our virtual line printer, <code>pslineprint</code>.</p>
<h2 id="about-postscript">About PostScript</h2>
<p>PostScript is a very mature stack-oriented programming language, described in the <a href="https://www.adobe.com/products/postscript/pdfs/PLRM.pdf">PostScript Language Reference Manual</a>. We will only need to use a few features of the language: to print text (including strange characters) using a specific typeface to specific locations on a page and to print multiple pages.</p>
<p>Every PS document must start with the line</p>
<pre><code>%!PS</code></pre>
<p>Then to print text we have to select a font.</p>
<pre><code>/Courier findfont
12 scalefont
setfont</code></pre>
<p>Every point on the page has a pair of coordinates; the lower left corner of the page is <span class="math inline">\((0,0)\)</span>, and <span class="math inline">\((h,k)\)</span> is <span class="math inline">\(h\)</span> points from the left edge and <span class="math inline">\(k\)</span> points from the bottom edge. At any given time while a PostScript program is running there is a “current” position where all drawing commands are carried out; we can change the current position with <code>moveto</code>. For example the following command moves the position to <span class="math inline">\((10,20)\)</span>.</p>
<pre><code>10 20 moveto</code></pre>
<p>This line pushes the numbers 10 and 20 onto a virtual stack, and then <code>moveto</code> pops the first two items (which are numbers) off of the stack and has the side effect of moving the current position to those coordinates. (A full discussion of <a href="https://en.wikipedia.org/wiki/Stack-oriented_programming_language">stack-oriented languages</a> is beyond our scope, but they are a very interesting topic and are very amenable to code generation.)</p>
<p>The <code>show</code> command prints a string at the current position using the current font; it even implicitly updates the current position so that multiple <code>show</code> commands work as expected. To actually render drawing commands to the page, we use <code>showpage</code>, and <code>%%Page:</code> starts a new page. (That last command is not clear to me, but my PostScript viewer requires it.) Putting this together, try copying the following to a file called <code>test.ps</code> and opening it in a PostScript viewer. (Note that the file must end with a newline!)</p>
<pre><code>%!PS
/Courier findfont
12 scalefont
setfont

%%Page: 1
10 20 moveto
(hello world!) show
showpage

%%Page: 2
10 20 moveto
(what is this) show
showpage</code></pre>
<p>Okay. But there is one major limitation of PostScript that we’ll have to work around: PostScript does not play very nicely with Unicode. The <code>show</code> function only behaves as expected on 8-bit ASCII text. The workaround is to use the function <code>glyphshow</code>, which takes special symbolic names for glyphs escaped with a forward slash. For instance,</p>
<pre><code>/alpha glyphshow</code></pre>
<p>prints the greek letter alpha as long as the current font has a glyph for it. (The version of Courier on my system does not have glyphs for very many special characters, so I will instead use <code>FreeMono</code> from the <a href="https://www.gnu.org/software/freefont/">GNU Foundation</a>.) Julian Wiseman has compiled a nice <a href="http://www.jdawiseman.com/papers/trivia/character-entities.html">table of PostScript glyph names</a> (<a href="https://web.archive.org/web/20160315094516/http://jdawiseman.com/papers/trivia/character-entities.html">archive link</a>).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="ot">unicodeToPS ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">unicodeToPS <span class="fu">=</span> renderPSText <span class="fu">.</span> toPSText</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">data</span> <span class="dt">PSChar</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="fu">=</span> <span class="dt">Plain</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="fu">|</span> <span class="dt">Glyph</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="kw">type</span> <span class="dt">PSText</span> <span class="fu">=</span> [<span class="dt">PSChar</span>]</a>
<a class="sourceLine" id="cb7-11" data-line-number="11"></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="ot">renderPSText ::</span> <span class="dt">PSText</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">renderPSText <span class="fu">=</span> concatMap renderPSChar</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="ot">    renderPSChar ::</span> <span class="dt">PSChar</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">    renderPSChar (<span class="dt">Plain</span> s)</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">      <span class="fu">=</span> <span class="st">&quot;(&quot;</span> <span class="fu">++</span> s <span class="fu">++</span> <span class="st">&quot;) show\n&quot;</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">    renderPSChar (<span class="dt">Glyph</span> g)</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">      <span class="fu">=</span> <span class="st">&quot;/&quot;</span> <span class="fu">++</span> g <span class="fu">++</span> <span class="st">&quot; glyphshow\n&quot;</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="ot">toPSText ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">PSText</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">toPSText <span class="fu">=</span> condense <span class="fu">.</span> map toPSChar</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="ot">    condense ::</span> <span class="dt">PSText</span> <span class="ot">-&gt;</span> <span class="dt">PSText</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27">    condense <span class="fu">=</span> unfoldr first</a>
<a class="sourceLine" id="cb7-28" data-line-number="28"></a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="ot">    first ::</span> <span class="dt">PSText</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">PSChar</span>, <span class="dt">PSText</span>)</a>
<a class="sourceLine" id="cb7-30" data-line-number="30">    first [] <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">    first (x<span class="fu">:</span>xs) <span class="fu">=</span> <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">      <span class="dt">Glyph</span> g <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Glyph</span> g, xs)</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">      <span class="dt">Plain</span> c <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34">        <span class="kw">let</span> (ps,rest) <span class="fu">=</span> span isPlain xs</a>
<a class="sourceLine" id="cb7-35" data-line-number="35">        cs <span class="ot">&lt;-</span> fmap concat <span class="fu">$</span> sequence <span class="fu">$</span> map fromPlain ps</a>
<a class="sourceLine" id="cb7-36" data-line-number="36">        <span class="dt">Just</span> (<span class="dt">Plain</span> (c<span class="fu">++</span>cs), rest)</a>
<a class="sourceLine" id="cb7-37" data-line-number="37"></a>
<a class="sourceLine" id="cb7-38" data-line-number="38"><span class="ot">    isPlain ::</span> <span class="dt">PSChar</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb7-39" data-line-number="39">    isPlain (<span class="dt">Plain</span> _) <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb7-40" data-line-number="40">    isPlain (<span class="dt">Glyph</span> _) <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb7-41" data-line-number="41"></a>
<a class="sourceLine" id="cb7-42" data-line-number="42"><span class="ot">    fromPlain ::</span> <span class="dt">PSChar</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb7-43" data-line-number="43">    fromPlain (<span class="dt">Plain</span> s) <span class="fu">=</span> <span class="dt">Just</span> s</a>
<a class="sourceLine" id="cb7-44" data-line-number="44">    fromPlain (<span class="dt">Glyph</span> _) <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-45" data-line-number="45"></a>
<a class="sourceLine" id="cb7-46" data-line-number="46"></a>
<a class="sourceLine" id="cb7-47" data-line-number="47"><span class="co">-- hold on to your butts</span></a>
<a class="sourceLine" id="cb7-48" data-line-number="48"><span class="ot">toPSChar ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">PSChar</span></a>
<a class="sourceLine" id="cb7-49" data-line-number="49">toPSChar x <span class="fu">=</span> <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-50" data-line-number="50">  <span class="ch">'\\'</span>     <span class="ot">-&gt;</span> <span class="dt">Plain</span> <span class="st">&quot;\\\\&quot;</span></a>
<a class="sourceLine" id="cb7-51" data-line-number="51"></a>
<a class="sourceLine" id="cb7-52" data-line-number="52">  <span class="co">-- Greek Letters: Uppercase</span></a>
<a class="sourceLine" id="cb7-53" data-line-number="53">  <span class="ch">'\x0391'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Alpha&quot;</span></a>
<a class="sourceLine" id="cb7-54" data-line-number="54">  <span class="ch">'\x0392'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Beta&quot;</span></a>
<a class="sourceLine" id="cb7-55" data-line-number="55">  <span class="ch">'\x0393'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Gamma&quot;</span></a>
<a class="sourceLine" id="cb7-56" data-line-number="56">  <span class="ch">'\x0394'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Deltagreek&quot;</span></a>
<a class="sourceLine" id="cb7-57" data-line-number="57">  <span class="ch">'\x0395'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Epsilon&quot;</span></a>
<a class="sourceLine" id="cb7-58" data-line-number="58">  <span class="ch">'\x0396'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Zeta&quot;</span></a>
<a class="sourceLine" id="cb7-59" data-line-number="59">  <span class="ch">'\x0397'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Eta&quot;</span></a>
<a class="sourceLine" id="cb7-60" data-line-number="60">  <span class="ch">'\x0398'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Theta&quot;</span></a>
<a class="sourceLine" id="cb7-61" data-line-number="61">  <span class="ch">'\x0399'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Iota&quot;</span></a>
<a class="sourceLine" id="cb7-62" data-line-number="62">  <span class="ch">'\x039a'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Kappa&quot;</span></a>
<a class="sourceLine" id="cb7-63" data-line-number="63">  <span class="ch">'\x039b'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Lambda&quot;</span></a>
<a class="sourceLine" id="cb7-64" data-line-number="64">  <span class="ch">'\x039c'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Mu&quot;</span></a>
<a class="sourceLine" id="cb7-65" data-line-number="65">  <span class="ch">'\x039d'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Nu&quot;</span></a>
<a class="sourceLine" id="cb7-66" data-line-number="66">  <span class="ch">'\x039e'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Xi&quot;</span></a>
<a class="sourceLine" id="cb7-67" data-line-number="67">  <span class="ch">'\x039f'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Omicron&quot;</span></a>
<a class="sourceLine" id="cb7-68" data-line-number="68">  <span class="ch">'\x03a0'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Pi&quot;</span></a>
<a class="sourceLine" id="cb7-69" data-line-number="69">  <span class="ch">'\x03a1'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Rho&quot;</span></a>
<a class="sourceLine" id="cb7-70" data-line-number="70">  <span class="ch">'\x03a3'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Sigma&quot;</span></a>
<a class="sourceLine" id="cb7-71" data-line-number="71">  <span class="ch">'\x03a4'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Tau&quot;</span></a>
<a class="sourceLine" id="cb7-72" data-line-number="72">  <span class="ch">'\x03a5'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Upsilon&quot;</span></a>
<a class="sourceLine" id="cb7-73" data-line-number="73">  <span class="ch">'\x03a6'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Phi&quot;</span></a>
<a class="sourceLine" id="cb7-74" data-line-number="74">  <span class="ch">'\x03a7'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Chi&quot;</span></a>
<a class="sourceLine" id="cb7-75" data-line-number="75">  <span class="ch">'\x03a8'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Psi&quot;</span></a>
<a class="sourceLine" id="cb7-76" data-line-number="76">  <span class="ch">'\x03a9'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;Omegagreek&quot;</span></a>
<a class="sourceLine" id="cb7-77" data-line-number="77"></a>
<a class="sourceLine" id="cb7-78" data-line-number="78">  <span class="co">-- Greek letters: Lowercase</span></a>
<a class="sourceLine" id="cb7-79" data-line-number="79">  <span class="ch">'\x03b1'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;alpha&quot;</span></a>
<a class="sourceLine" id="cb7-80" data-line-number="80">  <span class="ch">'\x03b2'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;beta&quot;</span></a>
<a class="sourceLine" id="cb7-81" data-line-number="81">  <span class="ch">'\x03b3'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;gamma&quot;</span></a>
<a class="sourceLine" id="cb7-82" data-line-number="82">  <span class="ch">'\x03b4'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;delta&quot;</span></a>
<a class="sourceLine" id="cb7-83" data-line-number="83">  <span class="ch">'\x03b5'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;epsilon&quot;</span></a>
<a class="sourceLine" id="cb7-84" data-line-number="84">  <span class="ch">'\x03b6'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;zeta&quot;</span></a>
<a class="sourceLine" id="cb7-85" data-line-number="85">  <span class="ch">'\x03b7'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;eta&quot;</span></a>
<a class="sourceLine" id="cb7-86" data-line-number="86">  <span class="ch">'\x03b8'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;theta&quot;</span></a>
<a class="sourceLine" id="cb7-87" data-line-number="87">  <span class="ch">'\x03b9'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;iota&quot;</span></a>
<a class="sourceLine" id="cb7-88" data-line-number="88">  <span class="ch">'\x03ba'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;kappa&quot;</span></a>
<a class="sourceLine" id="cb7-89" data-line-number="89">  <span class="ch">'\x03bb'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;lambda&quot;</span></a>
<a class="sourceLine" id="cb7-90" data-line-number="90">  <span class="ch">'\x03bc'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;mugreek&quot;</span></a>
<a class="sourceLine" id="cb7-91" data-line-number="91">  <span class="ch">'\x03bd'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;nu&quot;</span></a>
<a class="sourceLine" id="cb7-92" data-line-number="92">  <span class="ch">'\x03be'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;xi&quot;</span></a>
<a class="sourceLine" id="cb7-93" data-line-number="93">  <span class="ch">'\x03bf'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;omicron&quot;</span></a>
<a class="sourceLine" id="cb7-94" data-line-number="94">  <span class="ch">'\x03c0'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;pi&quot;</span></a>
<a class="sourceLine" id="cb7-95" data-line-number="95">  <span class="ch">'\x03c1'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;rho&quot;</span></a>
<a class="sourceLine" id="cb7-96" data-line-number="96">  <span class="ch">'\x03c2'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;sigmafinal&quot;</span></a>
<a class="sourceLine" id="cb7-97" data-line-number="97">  <span class="ch">'\x03c3'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;sigma&quot;</span></a>
<a class="sourceLine" id="cb7-98" data-line-number="98">  <span class="ch">'\x03c4'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;tau&quot;</span></a>
<a class="sourceLine" id="cb7-99" data-line-number="99">  <span class="ch">'\x03c5'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;upsilon&quot;</span></a>
<a class="sourceLine" id="cb7-100" data-line-number="100">  <span class="ch">'\x03c6'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;phi&quot;</span></a>
<a class="sourceLine" id="cb7-101" data-line-number="101">  <span class="ch">'\x03c7'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;chi&quot;</span></a>
<a class="sourceLine" id="cb7-102" data-line-number="102">  <span class="ch">'\x03c8'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;psi&quot;</span></a>
<a class="sourceLine" id="cb7-103" data-line-number="103">  <span class="ch">'\x03c9'</span> <span class="ot">-&gt;</span> <span class="dt">Glyph</span> <span class="st">&quot;omega&quot;</span></a>
<a class="sourceLine" id="cb7-104" data-line-number="104"></a>
<a class="sourceLine" id="cb7-105" data-line-number="105">  <span class="co">-- Otherwise</span></a>
<a class="sourceLine" id="cb7-106" data-line-number="106">  _        <span class="ot">-&gt;</span> <span class="dt">Plain</span> [x]</a></code></pre></div>
<p>First, we’ll write a black-box module that exports only one function, <code>unicodeToPS</code>, with the sole purpose of taking a string of unicode characters and returning the PostScript code needed to print it. The implementation of <code>unicodeToPS</code> is straigtforward, but tedious; we march down the string and chop it into ASCII and non-ASCII parts. The ASCII parts are handled with <code>show</code> and the non-ASCII parts handled one character at a time with <code>glyphshow</code>.</p>
<h2 id="limiting-the-scope">Limiting the Scope</h2>
<p>Before writing any code for the printer itself, let’s decide what it will and will not do:</p>
<ul>
<li>It <strong>will</strong> print lines of unformatted unicode text in a fixed-width font (as nature intended).</li>
<li>It <strong>will not</strong> worry about wrapping lines. If we try to print a line that is too long for the page, it will silently march off the edge.</li>
<li>It <strong>will not</strong> worry about page headings or page numbers.</li>
<li>It <strong>will not</strong> print multiple files – only lines from <code>stdin</code>.</li>
<li>It <strong>will not</strong> interpret escape codes or formatting commands.</li>
</ul>
<p>All of the “will not” tasks will be left for other tools to deal with; the virtual printer itself will be as simple as possible.</p>
<h2 id="modeling-a-printer">Modeling a Printer</h2>
<p>Now for the virtual line printer. We will think of a line printer as a machine which prints lines in the context of some basic internal state. Some state we can think of as configurable, but fixed: page margins, font size, line spacing, and page size. We use an extremely basic model of page geometry. Other state is updated as the line printer prints lines: the current page number and the current line number. (The <code>pageInProcess</code> flag is set whenever the current page has text printed on it; this is needed later.)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Geom</span> <span class="fu">=</span> <span class="dt">Geom</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  {<span class="ot"> fontSize   ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  ,<span class="ot"> lineSkip   ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  ,<span class="ot"> vMargin    ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  ,<span class="ot"> hMargin    ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  ,<span class="ot"> pageHeight ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  ,<span class="ot"> pageWidth  ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  } <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">-- letter size, 12 pt type</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="ot">defaultGeom ::</span> <span class="dt">Geom</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">defaultGeom <span class="fu">=</span> <span class="dt">Geom</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  { fontSize   <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">  , lineSkip   <span class="fu">=</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  , vMargin    <span class="fu">=</span> <span class="dv">28</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">  , hMargin    <span class="fu">=</span> <span class="dv">32</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">  , pageHeight <span class="fu">=</span> <span class="dv">792</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18">  , pageWidth  <span class="fu">=</span> <span class="dv">612</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">  }</a>
<a class="sourceLine" id="cb8-20" data-line-number="20"></a>
<a class="sourceLine" id="cb8-21" data-line-number="21"></a>
<a class="sourceLine" id="cb8-22" data-line-number="22"><span class="kw">data</span> <span class="dt">LPState</span> <span class="fu">=</span> <span class="dt">LPState</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23">  {<span class="ot"> pageSettings  ::</span> <span class="dt">Geom</span></a>
<a class="sourceLine" id="cb8-24" data-line-number="24">  ,<span class="ot"> currentLine   ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25">  ,<span class="ot"> currentPage   ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb8-26" data-line-number="26">  ,<span class="ot"> pageInProcess ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb8-27" data-line-number="27">  }</a>
<a class="sourceLine" id="cb8-28" data-line-number="28"></a>
<a class="sourceLine" id="cb8-29" data-line-number="29"></a>
<a class="sourceLine" id="cb8-30" data-line-number="30"><span class="ot">makeLPState ::</span> <span class="dt">Geom</span> <span class="ot">-&gt;</span> <span class="dt">LPState</span></a>
<a class="sourceLine" id="cb8-31" data-line-number="31">makeLPState geom  <span class="fu">=</span> <span class="dt">LPState</span></a>
<a class="sourceLine" id="cb8-32" data-line-number="32">  { pageSettings  <span class="fu">=</span> geom</a>
<a class="sourceLine" id="cb8-33" data-line-number="33">  , currentLine   <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb8-34" data-line-number="34">  , currentPage   <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb8-35" data-line-number="35">  , pageInProcess <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb8-36" data-line-number="36">  }</a></code></pre></div>
<p>From the page geometry, we can compute two important quantities: the number of lines that can be printed on one page, and the position on the page of each line.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ot">numLinesPerPage ::</span> <span class="dt">Geom</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">numLinesPerPage geom <span class="fu">=</span> floor ((pH <span class="fu">-</span> (<span class="dv">2</span><span class="fu">*</span>vM)) <span class="fu">/</span> (fS <span class="fu">+</span> lS))</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    pH <span class="fu">=</span> fromIntegral <span class="fu">$</span> pageHeight geom</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    vM <span class="fu">=</span> fromIntegral <span class="fu">$</span> vMargin geom</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    fS <span class="fu">=</span> fromIntegral <span class="fu">$</span> fontSize geom</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    lS <span class="fu">=</span> fromIntegral <span class="fu">$</span> lineSkip geom</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">-- lower left corner of line number k</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="ot">lineStartPos ::</span> <span class="dt">Geom</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>,<span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">lineStartPos geom k <span class="fu">=</span> (hM, pH <span class="fu">-</span> vM <span class="fu">-</span> k<span class="fu">*</span>(fS <span class="fu">+</span> lS))</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    hM <span class="fu">=</span> hMargin geom</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">    vM <span class="fu">=</span> vMargin geom</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">    pH <span class="fu">=</span> pageHeight geom</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">    fS <span class="fu">=</span> fontSize geom</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">    lS <span class="fu">=</span> lineSkip geom</a></code></pre></div>
<p>We’d like to expose a small number of primitive commands that the printer accepts: print a line of text, advance to the next line or the next page. This problem is well modeled by a monad. We use a custom monad stack with explicit state and IO.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">newtype</span> <span class="dt">LinePrinter</span> t <span class="fu">=</span> <span class="dt">LP</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  {<span class="ot"> runLP ::</span> <span class="dt">LPState</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (t, <span class="dt">LPState</span>) }</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="ot">runLPJob ::</span> <span class="dt">Geom</span> <span class="ot">-&gt;</span> <span class="dt">LinePrinter</span> t <span class="ot">-&gt;</span> <span class="dt">IO</span> t</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">runLPJob geom pr <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  (x,_) <span class="ot">&lt;-</span> runLP pr (makeLPState geom)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  return x</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">LinePrinter</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  return x <span class="fu">=</span> <span class="dt">LP</span> (\st <span class="ot">-&gt;</span> return (x, st))</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  x <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">LP</span> foo</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">      foo st1 <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">        (y,st2) <span class="ot">&lt;-</span> runLP x st1</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">        runLP (f y) st2</a>
<a class="sourceLine" id="cb10-17" data-line-number="17"></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">-- (necessary)</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="kw">instance</span> <span class="dt">Applicative</span> <span class="dt">LinePrinter</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">  pure <span class="fu">=</span> return</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">  (<span class="fu">&lt;*&gt;</span>) <span class="fu">=</span> ap</a>
<a class="sourceLine" id="cb10-22" data-line-number="22"></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="kw">instance</span> <span class="dt">Functor</span> <span class="dt">LinePrinter</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">  fmap <span class="fu">=</span> liftM</a></code></pre></div>
<p>Now the printer interface we expose is a small number of monadic functions. For instance, <code>lpPutStr</code> prints a string at the current line.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ot">lpPutStr ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">lpPutStr <span class="st">&quot;&quot;</span>  <span class="fu">=</span> return ()</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">lpPutStr str <span class="fu">=</span> lpStartPage <span class="fu">&gt;&gt;</span> <span class="dt">LP</span> write</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    write st <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      <span class="kw">let</span> (x,y) <span class="fu">=</span> lineStartPos (pageSettings st) (currentLine st)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">      putStrLn <span class="fu">$</span> show x <span class="fu">++</span> <span class="st">&quot; &quot;</span> <span class="fu">++</span> show y <span class="fu">++</span> <span class="st">&quot; moveto&quot;</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      putStr <span class="fu">$</span> unicodeToPS str</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">      return ((), st)</a></code></pre></div>
<p><code>lpLineFeed</code> advances the “print head” to the next line.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="ot">lpLineFeed ::</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">lpLineFeed <span class="fu">=</span> lpStartPage <span class="fu">&gt;&gt;</span> <span class="dt">LP</span> lf</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    lf st <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">        (kOld,mOld) <span class="fu">=</span> (currentLine st, currentPage st)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">        lpp <span class="fu">=</span> numLinesPerPage (pageSettings st)</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">      <span class="kw">if</span> kOld <span class="fu">+</span> <span class="dv">1</span> <span class="fu">&gt;</span> lpp</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">        <span class="kw">then</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">          putStrLn <span class="st">&quot;showpage\n&quot;</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">          return ((), st {currentLine <span class="fu">=</span> <span class="dv">1</span>, currentPage <span class="fu">=</span> mOld<span class="fu">+</span><span class="dv">1</span>, pageInProcess <span class="fu">=</span> <span class="dt">False</span>})</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">        <span class="kw">else</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">          return ((), st {currentLine <span class="fu">=</span> kOld<span class="fu">+</span><span class="dv">1</span>, currentPage <span class="fu">=</span> mOld})</a>
<a class="sourceLine" id="cb12-15" data-line-number="15"></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="ot">lpPutStrLn ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb12-18" data-line-number="18">lpPutStrLn str <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19">  lpPutStr str</a>
<a class="sourceLine" id="cb12-20" data-line-number="20">  lpLineFeed</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="ot">lpInitialize ::</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">lpInitialize <span class="fu">=</span> <span class="dt">LP</span> init</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    init st <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">      putStrLn <span class="st">&quot;%!PS&quot;</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">      putStrLn <span class="st">&quot;/FreeMono findfont&quot;</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">      <span class="kw">let</span> k <span class="fu">=</span> fontSize <span class="fu">$</span> pageSettings st</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">      putStrLn <span class="fu">$</span> show k <span class="fu">++</span> <span class="st">&quot; scalefont&quot;</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">      putStrLn <span class="st">&quot;setfont\n&quot;</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">      return ((), st)</a>
<a class="sourceLine" id="cb13-11" data-line-number="11"></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="ot">lpStartPage ::</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">lpStartPage <span class="fu">=</span> <span class="dt">LP</span> sp</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">    sp st <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">      <span class="kw">if</span> pageInProcess st <span class="fu">==</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">        <span class="kw">then</span> return ()</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">        <span class="kw">else</span> putStrLn <span class="fu">$</span> <span class="st">&quot;%%Page: &quot;</span> <span class="fu">++</span> show (currentPage st)</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">      return ((), st { pageInProcess <span class="fu">=</span> <span class="dt">True</span> })</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="ot">lpShutDown ::</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">lpShutDown <span class="fu">=</span> <span class="dt">LP</span> sd</a>
<a class="sourceLine" id="cb13-23" data-line-number="23">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24">    sd st <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">        <span class="kw">if</span> pageInProcess st <span class="fu">==</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26">          <span class="kw">then</span> return ()</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">          <span class="kw">else</span> putStrLn <span class="st">&quot;showpage&quot;</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">        return ((), st { pageInProcess <span class="fu">=</span> <span class="dt">False</span> })</a></code></pre></div>
<p>Putting these together, the <code>lpPrintLns</code> function prints a list of lines.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="ot">lpPrintLns ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">lpPrintLns lns <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  lpInitialize</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  mapM_ lpPutStrLn lns</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  lpShutDown</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="ot">lpPutCCStrLn ::</span> <span class="dt">CCLine</span> <span class="ot">-&gt;</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">lpPutCCStrLn x <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  mapM_ lpPutStr (fromCCLine x)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  lpLineFeed</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="ot">lpPrintCCLns ::</span> [<span class="dt">CCLine</span>] <span class="ot">-&gt;</span> <span class="dt">LinePrinter</span> ()</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">lpPrintCCLns lns <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  lpInitialize</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">  mapM_ lpPutCCStrLn lns</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">  lpShutDown</a></code></pre></div>
<p>It is straightforward to write versions of <code>lpPutStr</code> and <code>lpPrintLns</code> that work on carriage control encoded lines we worked with in <code>linecount</code> – doing so allows our virtual line printer to produce overstruck characters.</p>
<h2 id="the-main-program">The Main Program</h2>
<p>All we’ve built so far is a small monadic language which simulates a line printer; all the complexity of PostScript (and integrating unicode with PostScript) is hidden away behind the <code>LinePrinter</code> interface. Next we need to wire this language to the command line so it can interact seamlessly with our other tools.</p>
<p>This tool differs from the others we’ve built so far in that our virtual line printer has a few different knobs the user may want to adjust: specifically, the page geometry parameters. To make our tool unopinionated, we should expose these parameters to the user at the command line. And to minimize the burden on the user the order in which these parameters are specified should not matter. Handling several different possible options in any order <em>by hand</em> is tedious and error prone, so we will instead use the standard <code>GetOpt</code> library. This library allows us to declaratively specify what options our program has and provides several useful functions for reading and processing those options. For programs with very simple parameters the full power of <code>GetOpt</code> is overkill, but it is appropriate here.</p>
<p>The main program logic is very simple. We read the command line options, interpret them as a page geometry specification, and the run our monadic line printer on <code>stdin</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  args <span class="ot">&lt;-</span> getArgs</a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  <span class="kw">let</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    argErr  <span class="fu">=</span> reportErrorMsgs [usageInfo <span class="st">&quot;options&quot;</span> options]</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    corrErr <span class="fu">=</span> reportErrorMsgs [<span class="st">&quot;corrupt input&quot;</span>]</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"></a>
<a class="sourceLine" id="cb16-9" data-line-number="9">  <span class="co">-- read options</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">  flags <span class="ot">&lt;-</span> <span class="kw">case</span> getOpt <span class="dt">Permute</span> options args <span class="kw">of</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">    (opts, [], []) <span class="ot">-&gt;</span> return <span class="fu">$</span> foldl (<span class="fu">&gt;&gt;=</span>) (<span class="dt">Just</span> defaultFlags) opts</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">    otherwise      <span class="ot">-&gt;</span> argErr <span class="fu">&gt;&gt;</span> exitFailure</a>
<a class="sourceLine" id="cb16-13" data-line-number="13"></a>
<a class="sourceLine" id="cb16-14" data-line-number="14">  <span class="co">-- process options</span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15">  (geom, mode) <span class="ot">&lt;-</span> <span class="kw">case</span> flags <span class="kw">of</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> argErr <span class="fu">&gt;&gt;</span> exitFailure</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    <span class="dt">Just</span> fs <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19">        g <span class="fu">=</span> defaultGeom</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">          { fontSize <span class="fu">=</span> fFontSize fs</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">          , lineSkip <span class="fu">=</span> fLineSkip fs</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">          , vMargin  <span class="fu">=</span> fVMargin fs</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">          , hMargin  <span class="fu">=</span> fHMargin fs</a>
<a class="sourceLine" id="cb16-24" data-line-number="24">          }</a>
<a class="sourceLine" id="cb16-25" data-line-number="25"></a>
<a class="sourceLine" id="cb16-26" data-line-number="26">      return (g, fMode fs)</a>
<a class="sourceLine" id="cb16-27" data-line-number="27"></a>
<a class="sourceLine" id="cb16-28" data-line-number="28">  stdin <span class="ot">&lt;-</span> getContents</a>
<a class="sourceLine" id="cb16-29" data-line-number="29"></a>
<a class="sourceLine" id="cb16-30" data-line-number="30">  <span class="kw">case</span> mode <span class="kw">of</span></a>
<a class="sourceLine" id="cb16-31" data-line-number="31">    <span class="dt">Lines</span> <span class="ot">-&gt;</span> runLPJob geom <span class="fu">$</span> lpPrintLns <span class="fu">$</span> getLines stdin</a>
<a class="sourceLine" id="cb16-32" data-line-number="32"></a>
<a class="sourceLine" id="cb16-33" data-line-number="33">    <span class="dt">ASACC</span> <span class="ot">-&gt;</span> <span class="kw">case</span> readCCLines stdin <span class="kw">of</span></a>
<a class="sourceLine" id="cb16-34" data-line-number="34">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> corrErr <span class="fu">&gt;&gt;</span> exitFailure</a>
<a class="sourceLine" id="cb16-35" data-line-number="35">      <span class="dt">Just</span> xs <span class="ot">-&gt;</span> runLPJob geom <span class="fu">$</span> lpPrintCCLns xs</a>
<a class="sourceLine" id="cb16-36" data-line-number="36"></a>
<a class="sourceLine" id="cb16-37" data-line-number="37">  exitSuccess</a>
<a class="sourceLine" id="cb16-38" data-line-number="38"></a>
<a class="sourceLine" id="cb16-39" data-line-number="39"></a>
<a class="sourceLine" id="cb16-40" data-line-number="40"><span class="co">{- Options -}</span></a>
<a class="sourceLine" id="cb16-41" data-line-number="41"></a>
<a class="sourceLine" id="cb16-42" data-line-number="42"><span class="kw">data</span> <span class="dt">Mode</span> <span class="fu">=</span> <span class="dt">Lines</span> <span class="fu">|</span> <span class="dt">ASACC</span></a>
<a class="sourceLine" id="cb16-43" data-line-number="43"></a>
<a class="sourceLine" id="cb16-44" data-line-number="44"><span class="kw">data</span> <span class="dt">Flags</span> <span class="fu">=</span> <span class="dt">Flags</span></a>
<a class="sourceLine" id="cb16-45" data-line-number="45">  {<span class="ot"> fFontSize ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb16-46" data-line-number="46">  ,<span class="ot"> fLineSkip ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb16-47" data-line-number="47">  ,<span class="ot"> fVMargin  ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb16-48" data-line-number="48">  ,<span class="ot"> fHMargin  ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb16-49" data-line-number="49">  ,<span class="ot"> fMode     ::</span> <span class="dt">Mode</span></a>
<a class="sourceLine" id="cb16-50" data-line-number="50">  }</a>
<a class="sourceLine" id="cb16-51" data-line-number="51"></a>
<a class="sourceLine" id="cb16-52" data-line-number="52"></a>
<a class="sourceLine" id="cb16-53" data-line-number="53"><span class="ot">defaultFlags ::</span> <span class="dt">Flags</span></a>
<a class="sourceLine" id="cb16-54" data-line-number="54">defaultFlags <span class="fu">=</span> <span class="dt">Flags</span></a>
<a class="sourceLine" id="cb16-55" data-line-number="55">  { fFontSize <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb16-56" data-line-number="56">  , fLineSkip <span class="fu">=</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb16-57" data-line-number="57">  , fVMargin  <span class="fu">=</span> <span class="dv">32</span></a>
<a class="sourceLine" id="cb16-58" data-line-number="58">  , fHMargin  <span class="fu">=</span> <span class="dv">28</span></a>
<a class="sourceLine" id="cb16-59" data-line-number="59">  , fMode     <span class="fu">=</span> <span class="dt">Lines</span></a>
<a class="sourceLine" id="cb16-60" data-line-number="60">  }</a>
<a class="sourceLine" id="cb16-61" data-line-number="61"></a>
<a class="sourceLine" id="cb16-62" data-line-number="62"></a>
<a class="sourceLine" id="cb16-63" data-line-number="63"><span class="ot">options ::</span> [<span class="dt">OptDescr</span> (<span class="dt">Flags</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Flags</span>)]</a>
<a class="sourceLine" id="cb16-64" data-line-number="64">options <span class="fu">=</span></a>
<a class="sourceLine" id="cb16-65" data-line-number="65">  [ <span class="dt">Option</span> [] [<span class="st">&quot;font-size&quot;</span>]</a>
<a class="sourceLine" id="cb16-66" data-line-number="66">      (<span class="dt">ReqArg</span> readFontSize <span class="st">&quot;INT&quot;</span>)</a>
<a class="sourceLine" id="cb16-67" data-line-number="67">      <span class="st">&quot;font size in points&quot;</span></a>
<a class="sourceLine" id="cb16-68" data-line-number="68"></a>
<a class="sourceLine" id="cb16-69" data-line-number="69">  , <span class="dt">Option</span> [] [<span class="st">&quot;line-skip&quot;</span>]</a>
<a class="sourceLine" id="cb16-70" data-line-number="70">      (<span class="dt">ReqArg</span> readLineSkip <span class="st">&quot;INT&quot;</span>)</a>
<a class="sourceLine" id="cb16-71" data-line-number="71">      <span class="st">&quot;line spacing in points&quot;</span></a>
<a class="sourceLine" id="cb16-72" data-line-number="72"></a>
<a class="sourceLine" id="cb16-73" data-line-number="73">  , <span class="dt">Option</span> [] [<span class="st">&quot;vmargin&quot;</span>]</a>
<a class="sourceLine" id="cb16-74" data-line-number="74">      (<span class="dt">ReqArg</span> readVMargin <span class="st">&quot;INT&quot;</span>)</a>
<a class="sourceLine" id="cb16-75" data-line-number="75">      <span class="st">&quot;vertical page margins in points&quot;</span></a>
<a class="sourceLine" id="cb16-76" data-line-number="76"></a>
<a class="sourceLine" id="cb16-77" data-line-number="77">  , <span class="dt">Option</span> [] [<span class="st">&quot;hmargin&quot;</span>]</a>
<a class="sourceLine" id="cb16-78" data-line-number="78">      (<span class="dt">ReqArg</span> readHMargin <span class="st">&quot;INT&quot;</span>)</a>
<a class="sourceLine" id="cb16-79" data-line-number="79">      <span class="st">&quot;left page margin in points&quot;</span></a>
<a class="sourceLine" id="cb16-80" data-line-number="80"></a>
<a class="sourceLine" id="cb16-81" data-line-number="81">  , <span class="dt">Option</span> [] [<span class="st">&quot;asacc&quot;</span>]</a>
<a class="sourceLine" id="cb16-82" data-line-number="82">      (<span class="dt">NoArg</span> (\opts <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="fu">$</span> opts { fMode <span class="fu">=</span> <span class="dt">ASACC</span> }))</a>
<a class="sourceLine" id="cb16-83" data-line-number="83">      <span class="st">&quot;interpret basic ASA carriage control codes&quot;</span></a>
<a class="sourceLine" id="cb16-84" data-line-number="84">  ]</a>
<a class="sourceLine" id="cb16-85" data-line-number="85">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb16-86" data-line-number="86">    readFontSize str opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-87" data-line-number="87">      k <span class="ot">&lt;-</span> readDecimalNat str</a>
<a class="sourceLine" id="cb16-88" data-line-number="88">      return <span class="fu">$</span> opts { fFontSize <span class="fu">=</span> k }</a>
<a class="sourceLine" id="cb16-89" data-line-number="89"></a>
<a class="sourceLine" id="cb16-90" data-line-number="90">    readLineSkip str opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-91" data-line-number="91">      k <span class="ot">&lt;-</span> readDecimalNat str</a>
<a class="sourceLine" id="cb16-92" data-line-number="92">      return <span class="fu">$</span> opts { fLineSkip <span class="fu">=</span> k }</a>
<a class="sourceLine" id="cb16-93" data-line-number="93"></a>
<a class="sourceLine" id="cb16-94" data-line-number="94">    readVMargin str opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-95" data-line-number="95">      k <span class="ot">&lt;-</span> readDecimalNat str</a>
<a class="sourceLine" id="cb16-96" data-line-number="96">      return <span class="fu">$</span> opts { fVMargin <span class="fu">=</span> k }</a>
<a class="sourceLine" id="cb16-97" data-line-number="97"></a>
<a class="sourceLine" id="cb16-98" data-line-number="98">    readHMargin str opts <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-99" data-line-number="99">      k <span class="ot">&lt;-</span> readDecimalNat str</a>
<a class="sourceLine" id="cb16-100" data-line-number="100">      return <span class="fu">$</span> opts { fHMargin <span class="fu">=</span> k }</a></code></pre></div>
<p>Unlike our other tools, it is not so easy to write automated tests of a program like this. As an example, though, try running the following pipeline:</p>
<pre><code>sth-echo &quot;hello\b\b\b\b\b_____&quot; &quot;world!&quot;
 | sth-unescape
 | sth-overstrike
 | sth-pslineprint --asacc
 &gt; psprinttest.ps</code></pre>
<p>This should produce a page with two lines: the first with the word “hello” underlined.</p>
<p>When every program operates on plain text, making minimal assumptions about formats, it is easy to chain them together to perform complex tasks. Later on we will write programs to make the output of <code>pslineprint</code> prettier: line wrapping, pagination, and so on. By keeping this functionality out of the printer itself, all programs can stay small and modular.</p>
<p>Later, we may find occasion to enhance our virtual line printer with the ability to change to a bold or italicized font. Because of the modular, monadic design, this will be straightforward.</p>
<h2 id="old-stuff">Old Stuff</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co">-- split on \n</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="ot">getLines ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">getLines <span class="fu">=</span> unfoldr firstLine</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="ot">    firstLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">String</span>, <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">    firstLine xs <span class="fu">=</span> <span class="kw">case</span> break (<span class="fu">==</span> <span class="ch">'\n'</span>) xs <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">      (<span class="st">&quot;&quot;</span>,<span class="st">&quot;&quot;</span>)   <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">      (as,<span class="st">&quot;&quot;</span>)   <span class="ot">-&gt;</span> <span class="dt">Just</span> (as,<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">      (as,b<span class="fu">:</span>bs) <span class="ot">-&gt;</span> <span class="dt">Just</span> (as,bs)</a>
<a class="sourceLine" id="cb18-10" data-line-number="10"></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="co">-- write list of messages to stderr</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="ot">reportErrorMsgs ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">reportErrorMsgs errs <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15">  name <span class="ot">&lt;-</span> getProgName</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">  sequence_ <span class="fu">$</span> map (hPutStrLn stderr) <span class="fu">$</span> ((name <span class="fu">++</span> <span class="st">&quot; error&quot;</span>)<span class="fu">:</span>errs)</a>
<a class="sourceLine" id="cb18-17" data-line-number="17"></a>
<a class="sourceLine" id="cb18-18" data-line-number="18"></a>
<a class="sourceLine" id="cb18-19" data-line-number="19"><span class="co">-- parse a natural number base 10</span></a>
<a class="sourceLine" id="cb18-20" data-line-number="20"><span class="ot">readDecimalNat ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21">readDecimalNat xs <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb18-22" data-line-number="22">  ys <span class="ot">&lt;-</span> sequence <span class="fu">$</span> map decToInt <span class="fu">$</span> reverse xs</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">  return <span class="fu">$</span> sum <span class="fu">$</span> zipWith (<span class="fu">*</span>) ys [<span class="dv">10</span><span class="fu">^</span>t <span class="fu">|</span> t <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>]]</a>
<a class="sourceLine" id="cb18-24" data-line-number="24">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb18-25" data-line-number="25"><span class="ot">    decToInt ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb18-26" data-line-number="26">    decToInt x <span class="fu">=</span> lookup x</a>
<a class="sourceLine" id="cb18-27" data-line-number="27">      [ (<span class="ch">'0'</span>,<span class="dv">0</span>), (<span class="ch">'1'</span>,<span class="dv">1</span>), (<span class="ch">'2'</span>,<span class="dv">2</span>), (<span class="ch">'3'</span>,<span class="dv">3</span>), (<span class="ch">'4'</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb18-28" data-line-number="28">      , (<span class="ch">'5'</span>,<span class="dv">5</span>), (<span class="ch">'6'</span>,<span class="dv">6</span>), (<span class="ch">'7'</span>,<span class="dv">7</span>), (<span class="ch">'8'</span>,<span class="dv">8</span>), (<span class="ch">'9'</span>,<span class="dv">9</span>)</a>
<a class="sourceLine" id="cb18-29" data-line-number="29">      ]</a>
<a class="sourceLine" id="cb18-30" data-line-number="30"></a>
<a class="sourceLine" id="cb18-31" data-line-number="31"></a>
<a class="sourceLine" id="cb18-32" data-line-number="32"><span class="ot">unfoldrMaybe ::</span> (b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Maybe</span> (a,b))) <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [a]</a>
<a class="sourceLine" id="cb18-33" data-line-number="33">unfoldrMaybe f x <span class="fu">=</span> <span class="kw">case</span> f x <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-34" data-line-number="34">  <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb18-35" data-line-number="35">  <span class="dt">Just</span> <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> []</a>
<a class="sourceLine" id="cb18-36" data-line-number="36">  <span class="dt">Just</span> (<span class="dt">Just</span> (a,b)) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb18-37" data-line-number="37">    as <span class="ot">&lt;-</span> unfoldrMaybe f b</a>
<a class="sourceLine" id="cb18-38" data-line-number="38">    <span class="dt">Just</span> (a<span class="fu">:</span>as)</a>
<a class="sourceLine" id="cb18-39" data-line-number="39"></a>
<a class="sourceLine" id="cb18-40" data-line-number="40"></a>
<a class="sourceLine" id="cb18-41" data-line-number="41"><span class="kw">data</span> <span class="dt">CCLine</span></a>
<a class="sourceLine" id="cb18-42" data-line-number="42">  <span class="fu">=</span> <span class="dt">CCLine</span> [<span class="dt">String</span>]</a>
<a class="sourceLine" id="cb18-43" data-line-number="43">  <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb18-44" data-line-number="44"></a>
<a class="sourceLine" id="cb18-45" data-line-number="45"><span class="ot">fromCCLine ::</span> <span class="dt">CCLine</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]</a>
<a class="sourceLine" id="cb18-46" data-line-number="46">fromCCLine (<span class="dt">CCLine</span> xs) <span class="fu">=</span> xs</a>
<a class="sourceLine" id="cb18-47" data-line-number="47"></a>
<a class="sourceLine" id="cb18-48" data-line-number="48"><span class="ot">readCCLines ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">CCLine</span>]</a>
<a class="sourceLine" id="cb18-49" data-line-number="49">readCCLines <span class="fu">=</span> unfoldrMaybe readFirstCCLine <span class="fu">.</span> getLines</a>
<a class="sourceLine" id="cb18-50" data-line-number="50">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb18-51" data-line-number="51"><span class="ot">    readFirstCCLine ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Maybe</span> (<span class="dt">CCLine</span>, [<span class="dt">String</span>]))</a>
<a class="sourceLine" id="cb18-52" data-line-number="52">    readFirstCCLine [] <span class="fu">=</span> <span class="dt">Just</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb18-53" data-line-number="53">    readFirstCCLine ((<span class="ch">' '</span><span class="fu">:</span>cs)<span class="fu">:</span>ds) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb18-54" data-line-number="54">      <span class="kw">let</span></a>
<a class="sourceLine" id="cb18-55" data-line-number="55">        (us,vs) <span class="fu">=</span> span (isPrefixOf <span class="st">&quot;+&quot;</span>) ds</a>
<a class="sourceLine" id="cb18-56" data-line-number="56"></a>
<a class="sourceLine" id="cb18-57" data-line-number="57">        stripPlus xs <span class="fu">=</span> <span class="kw">case</span> xs <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-58" data-line-number="58">          <span class="ch">'+'</span><span class="fu">:</span>ys    <span class="ot">-&gt;</span> <span class="dt">Just</span> ys</a>
<a class="sourceLine" id="cb18-59" data-line-number="59">          otherwise <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb18-60" data-line-number="60"></a>
<a class="sourceLine" id="cb18-61" data-line-number="61">      <span class="kw">case</span> sequence <span class="fu">$</span> map stripPlus us <span class="kw">of</span></a>
<a class="sourceLine" id="cb18-62" data-line-number="62">        <span class="dt">Just</span> ws <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">CCLine</span> <span class="fu">$</span> cs<span class="fu">:</span>ws, vs))</a>
<a class="sourceLine" id="cb18-63" data-line-number="63">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb18-64" data-line-number="64">    readFirstCCLine _ <span class="fu">=</span> <span class="dt">Nothing</span></a></code></pre></div>


<!-- END BODY -->
</div>

<div id="footer">
  Site generated by
  <a href="http://jaspervdj.be/hakyll">Hakyll</a>
</div>
</body>
</html>
