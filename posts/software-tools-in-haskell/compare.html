<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>nbloomf.blog - Software Tools in Haskell: compare</title>
<link rel="stylesheet" type="text/css" href="../../css/default.css" />
<link rel="icon" href="../../raw/gfx/icon/favicon-32.png" />
<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../raw/gfx/icon/favicon-57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../raw/gfx/icon/favicon-114.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../raw/gfx/icon/favicon-152.png" />
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>

<body>
<div id="header">
  <div id="logo">
    <a href="../../index.html">nbloomf</a>
  </div>
  <div id="navigation">
    <a href="../../index.html">Home</a>
    <a href="../../pages/about.html">About</a>
    <a href="../../pages/projects.html">Projects</a>
    <a href="../../pages/contact.html">Contact</a>
    <a href="../../archive.html">Blog</a>
  </div>
</div>

<div id="content">
<h1>Software Tools in Haskell: compare</h1>
<!-- BEGIN BODY -->
<h2>find the first position where two text streams differ</h2>

<div class="info">
Posted on 2016-03-01 by nbloomf
</div>


<div class="info tags">Tags: <a href="../../tag/software-tools-in-haskell.html">software-tools-in-haskell</a>, <a href="../../tag/literate-haskell.html">literate-haskell</a></div>


<p>This page is part of a series on <a href="../../pages/sth/index.html">Software Tools in Haskell</a>.</p>

<p>This post is literate Haskell; you can load <a href="https://raw.githubusercontent.com/nbloomf/nbloomf.md/master/posts/software-tools-in-haskell/compare.lhs">the source</a> into GHCi and play along.</p>

<p>As usual, we start with some imports.</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="co">-- compare: find the first position where two text streams differ</span>
<span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Exit</span> (exitSuccess, exitFailure)
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Environment</span> (getArgs, getProgName)
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.IO</span> (hPutStrLn, stderr)
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.Maybe</span> (maybeToList)
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Data.List</span> (unfoldr)</code></pre></div>
<p>See also the <a href="../../posts/software-tools-in-haskell/Lib/Backslash.html">Backslash</a> module.</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">Lib.Backslash</span> (bsUnEsc)</code></pre></div>
<p>The purpose of <code>compare</code> is to detect whether or not two streams of text are byte-for-byte identical. This alone is simple enough, but the job is complicated by the fact that (1) there are a few useful places these text streams might come from and (2) in the (typical) case that the streams are <em>not</em> identical, we want to report the position of the first difference.</p>
<p>The <code>diffList</code> function takes two lists and returns the position of the earliest difference as well as the differing elements (if they exist).</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; diffList ::</span> (<span class="dt">Eq</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> (<span class="dt">Maybe</span> a, <span class="dt">Maybe</span> a, <span class="dt">Integer</span>)
<span class="ot">&gt;</span> diffList <span class="fu">=</span> comp <span class="dv">1</span>
<span class="ot">&gt;</span>   <span class="kw">where</span>
<span class="ot">&gt;</span>     comp _ []     []     <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dv">0</span>)
<span class="ot">&gt;</span>     comp k []     (y<span class="fu">:</span>_)  <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Just</span> y, k)
<span class="ot">&gt;</span>     comp k (x<span class="fu">:</span>_)  []     <span class="fu">=</span> (<span class="dt">Just</span> x, <span class="dt">Nothing</span>, k)
<span class="ot">&gt;</span>     comp k (x<span class="fu">:</span>xs) (y<span class="fu">:</span>ys) <span class="fu">=</span> <span class="kw">if</span> x <span class="fu">==</span> y
<span class="ot">&gt;</span>       <span class="kw">then</span> comp (k<span class="fu">+</span><span class="dv">1</span>) xs ys
<span class="ot">&gt;</span>       <span class="kw">else</span> (<span class="dt">Just</span> x, <span class="dt">Just</span> y, k)</code></pre></div>
<p>This isn’t quite what we want, though. The problem is that word “position”. The most useful <em>position</em> information will depend on what kind of text is being compared. For instance, when comparing line text we’d like to report the line and column numbers of the earliest difference, rather than just the character index. The <code>diffLists</code> function does this.</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; diffLists ::</span> (<span class="dt">Eq</span> a) <span class="ot">=&gt;</span> [[a]] <span class="ot">-&gt;</span> [[a]]
<span class="ot">&gt;</span>   <span class="ot">-&gt;</span> (<span class="dt">Maybe</span> [a], <span class="dt">Maybe</span> [a], <span class="dt">Integer</span>, <span class="dt">Integer</span>)
<span class="ot">&gt;</span> diffLists <span class="fu">=</span> comp <span class="dv">1</span>
<span class="ot">&gt;</span>   <span class="kw">where</span>
<span class="ot">&gt;</span>     comp _ []       []       <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dv">0</span>, <span class="dv">0</span>)
<span class="ot">&gt;</span>     comp m []       (ys<span class="fu">:</span>yss) <span class="fu">=</span> (<span class="dt">Nothing</span>, <span class="dt">Just</span> ys, m, <span class="dv">1</span>)
<span class="ot">&gt;</span>     comp m (xs<span class="fu">:</span>xss) []       <span class="fu">=</span> (<span class="dt">Just</span> xs, <span class="dt">Nothing</span>, m, <span class="dv">1</span>)
<span class="ot">&gt;</span>     comp m (xs<span class="fu">:</span>xss) (ys<span class="fu">:</span>yss) <span class="fu">=</span> <span class="kw">case</span> diffList xs ys <span class="kw">of</span>
<span class="ot">&gt;</span>       (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, _) <span class="ot">-&gt;</span> comp (m<span class="fu">+</span><span class="dv">1</span>) xss yss
<span class="ot">&gt;</span>       (_,_,n) <span class="ot">-&gt;</span> (<span class="dt">Just</span> xs, <span class="dt">Just</span> ys, m, n)</code></pre></div>
<p>Like we did with <code>echo</code>, we’ll allow the user to specify which kind of position they mean with a <code>--char</code> option (default is line). Now the streams to be compared (of which we need two) can come from one of three places:</p>
<ol style="list-style-type: decimal">
<li><code>stdin</code>,</li>
<li>a file (one or two), or</li>
<li>command line arguments (interpreted like <code>echo</code>).</li>
</ol>
<p>The main program first reads the arguments and extracts (1) the mode (char or line) of text being compared, (2) the name and contents of the first stream to be compared, and (3) the name and contents of the second stream to be compared. Then we evaluate either <code>diffList</code> or <code>diffLists</code> and report the results.</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="kw">data</span> <span class="dt">Mode</span> <span class="fu">=</span> <span class="dt">Chars</span> <span class="fu">|</span> <span class="dt">Lines</span>
<span class="ot">&gt;</span> 
<span class="ot">&gt; main ::</span> <span class="dt">IO</span> ()
<span class="ot">&gt;</span> main <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   args <span class="ot">&lt;-</span> getArgs
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>   <span class="co">-- interpret arguments</span>
<span class="ot">&gt;</span>   (mode,(name1,stream1),(name2,stream2)) <span class="ot">&lt;-</span> <span class="kw">do</span>
<span class="ot">&gt;</span>     <span class="kw">let</span>
<span class="ot">&gt;</span>       (flag,rest) <span class="fu">=</span> <span class="kw">case</span> args <span class="kw">of</span>
<span class="ot">&gt;</span>         (<span class="st">&quot;--char&quot;</span><span class="fu">:</span>xss) <span class="ot">-&gt;</span> (<span class="dt">Chars</span>,xss)
<span class="ot">&gt;</span>         xss            <span class="ot">-&gt;</span> (<span class="dt">Lines</span>,xss)
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>     <span class="kw">case</span> rest <span class="kw">of</span>
<span class="ot">&gt;</span>       (<span class="st">&quot;--to&quot;</span><span class="fu">:</span>ys) <span class="ot">-&gt;</span> <span class="kw">do</span>
<span class="ot">&gt;</span>         <span class="kw">let</span>
<span class="ot">&gt;</span>           as <span class="fu">=</span> bsUnEsc <span class="fu">$</span> <span class="kw">case</span> flag <span class="kw">of</span>
<span class="ot">&gt;</span>             <span class="dt">Chars</span> <span class="ot">-&gt;</span> concat ys
<span class="ot">&gt;</span>             <span class="dt">Lines</span> <span class="ot">-&gt;</span> fromLines ys
<span class="ot">&gt;</span>         bs <span class="ot">&lt;-</span> getContents
<span class="ot">&gt;</span>         return (flag,(<span class="st">&quot;args&quot;</span>,as),(<span class="st">&quot;stdin&quot;</span>,bs))
<span class="ot">&gt;</span>       [xs] <span class="ot">-&gt;</span> <span class="kw">do</span>
<span class="ot">&gt;</span>         as <span class="ot">&lt;-</span> readFile xs
<span class="ot">&gt;</span>         bs <span class="ot">&lt;-</span> getContents
<span class="ot">&gt;</span>         return (flag,(xs,as),(<span class="st">&quot;stdin&quot;</span>,bs))
<span class="ot">&gt;</span>       [xs,ys] <span class="ot">-&gt;</span> <span class="kw">do</span>
<span class="ot">&gt;</span>         as <span class="ot">&lt;-</span> readFile xs
<span class="ot">&gt;</span>         bs <span class="ot">&lt;-</span> readFile ys
<span class="ot">&gt;</span>         return (flag,(xs,as),(ys,bs))
<span class="ot">&gt;</span>       otherwise <span class="ot">-&gt;</span> argError <span class="fu">&gt;&gt;</span> exitFailure
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>   <span class="co">-- Some helpers</span>
<span class="ot">&gt;</span>   <span class="kw">let</span>
<span class="ot">&gt;</span>     (label1,label2) <span class="fu">=</span> padToLongerWith <span class="ch">' '</span> name1 name2
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>     report label [] <span class="fu">=</span> putStrLn <span class="fu">$</span> label <span class="fu">++</span> <span class="st">&quot;: (empty)&quot;</span>
<span class="ot">&gt;</span>     report label xs <span class="fu">=</span> putStrLn <span class="fu">$</span> label <span class="fu">++</span> <span class="st">&quot;: &quot;</span> <span class="fu">++</span> xs
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>   <span class="kw">case</span> mode <span class="kw">of</span>
<span class="ot">&gt;</span>     <span class="dt">Chars</span> <span class="ot">-&gt;</span> <span class="kw">case</span> diffList stream1 stream2 <span class="kw">of</span>
<span class="ot">&gt;</span>       (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, _) <span class="ot">-&gt;</span> return ()
<span class="ot">&gt;</span>       (x, y, t) <span class="ot">-&gt;</span> <span class="kw">do</span>
<span class="ot">&gt;</span>         putStrLn <span class="fu">$</span> <span class="st">&quot;first differ at column &quot;</span> <span class="fu">++</span> show t
<span class="ot">&gt;</span>         report label1 (maybeToList x)
<span class="ot">&gt;</span>         report label2 (maybeToList y)
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>     <span class="dt">Lines</span> <span class="ot">-&gt;</span> <span class="kw">case</span> diffLists (getLines stream1) (getLines stream2) <span class="kw">of</span>
<span class="ot">&gt;</span>       (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, _, _) <span class="ot">-&gt;</span> return ()
<span class="ot">&gt;</span>       (x, y, m, n) <span class="ot">-&gt;</span> <span class="kw">do</span>
<span class="ot">&gt;</span>         putStrLn <span class="fu">$</span> <span class="st">&quot;first differ at line &quot;</span> <span class="fu">++</span> show m <span class="fu">++</span> <span class="st">&quot;, column &quot;</span> <span class="fu">++</span> show n
<span class="ot">&gt;</span>         report label1 (concat <span class="fu">$</span> maybeToList x)
<span class="ot">&gt;</span>         report label2 (concat <span class="fu">$</span> maybeToList y) 
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>   exitSuccess
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt; argError ::</span> <span class="dt">IO</span> ()
<span class="ot">&gt;</span> argError <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   reportErrorMsgs
<span class="ot">&gt;</span>     [ <span class="st">&quot;usage:&quot;</span>
<span class="ot">&gt;</span>     , <span class="st">&quot;  compare FILE1 FILE2  -- find first discrepancy between FILE1 and FILE2&quot;</span>
<span class="ot">&gt;</span>     , <span class="st">&quot;  compare FILE         -- find first discrepancy between FILE and stdin&quot;</span>
<span class="ot">&gt;</span>     , <span class="st">&quot;  compare --to STR ... -- find first discrepancy between STRs and stdin&quot;</span>
<span class="ot">&gt;</span>     , <span class="st">&quot;options:&quot;</span>
<span class="ot">&gt;</span>     , <span class="st">&quot;  --char : compare as (unlined) character streams&quot;</span>
<span class="ot">&gt;</span>     ]
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt; padToLongerWith ::</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> ([a], [a])
<span class="ot">&gt;</span> padToLongerWith _ [] [] <span class="fu">=</span> ([],[])
<span class="ot">&gt;</span> padToLongerWith z [] ys <span class="fu">=</span> unzip <span class="fu">$</span> zip (repeat z) ys
<span class="ot">&gt;</span> padToLongerWith z xs [] <span class="fu">=</span> unzip <span class="fu">$</span> zip xs (repeat z)
<span class="ot">&gt;</span> padToLongerWith z (x<span class="fu">:</span>xs) (y<span class="fu">:</span>ys) <span class="fu">=</span>
<span class="ot">&gt;</span>   <span class="kw">let</span> (as,bs) <span class="fu">=</span> padToLongerWith z xs ys
<span class="ot">&gt;</span>   <span class="kw">in</span> (x<span class="fu">:</span>as, y<span class="fu">:</span>bs)
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt; fromLines ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">String</span>
<span class="ot">&gt;</span> fromLines xs <span class="fu">=</span> concat <span class="fu">$</span> zipWith (<span class="fu">++</span>) xs (repeat <span class="st">&quot;\n&quot;</span>)</code></pre></div>
<p><code>compare</code> can be used to implement a very simple testing scheme by comparing the output of some program under development to its “expected” output. One improvement I can think of is to have <code>compare</code> optionally output delimited data, to make it easier to extract this information with other tools.</p>
<h2 id="old-stuff">Old Stuff</h2>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="co">-- split on \n</span>
<span class="ot">&gt; getLines ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]
<span class="ot">&gt;</span> getLines <span class="fu">=</span> unfoldr firstLine
<span class="ot">&gt;</span>   <span class="kw">where</span>
<span class="ot">&gt;     firstLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">String</span>, <span class="dt">String</span>)
<span class="ot">&gt;</span>     firstLine xs <span class="fu">=</span> <span class="kw">case</span> break (<span class="fu">==</span> <span class="ch">'\n'</span>) xs <span class="kw">of</span>
<span class="ot">&gt;</span>       (<span class="st">&quot;&quot;</span>,<span class="st">&quot;&quot;</span>)   <span class="ot">-&gt;</span> <span class="dt">Nothing</span>
<span class="ot">&gt;</span>       (as,<span class="st">&quot;&quot;</span>)   <span class="ot">-&gt;</span> <span class="dt">Just</span> (as,<span class="st">&quot;&quot;</span>)
<span class="ot">&gt;</span>       (as,b<span class="fu">:</span>bs) <span class="ot">-&gt;</span> <span class="dt">Just</span> (as,bs)
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> <span class="co">-- write list of messages to stderr</span>
<span class="ot">&gt; reportErrorMsgs ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
<span class="ot">&gt;</span> reportErrorMsgs errs <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   name <span class="ot">&lt;-</span> getProgName
<span class="ot">&gt;</span>   sequence_ <span class="fu">$</span> map (hPutStrLn stderr) <span class="fu">$</span> ((name <span class="fu">++</span> <span class="st">&quot; error&quot;</span>)<span class="fu">:</span>errs)</code></pre></div>

<!-- END BODY -->
</div>

<div id="footer">
  Site generated by
  <a href="http://jaspervdj.be/hakyll">Hakyll</a>
</div>
</body>
</html>
