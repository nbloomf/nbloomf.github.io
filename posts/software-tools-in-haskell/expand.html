<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>nbloomf.blog - Software Tools in Haskell: expand</title>
<link rel="stylesheet" type="text/css" href="../../css/default.css" />
<link rel="icon" href="../../raw/gfx/icon/favicon-32.png" />
<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../raw/gfx/icon/favicon-57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../raw/gfx/icon/favicon-114.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../raw/gfx/icon/favicon-152.png" />
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>

<body>
<div id="header">
  <div id="logo">
    <a href="../../index.html">nbloomf</a>
  </div>
  <div id="navigation">
    <a href="../../index.html">Home</a>
    <a href="../../pages/about.html">About</a>
    <a href="../../pages/projects.html">Projects</a>
    <a href="../../pages/contact.html">Contact</a>
    <a href="../../archive.html">Blog</a>
  </div>
</div>

<div id="content">
<h1>Software Tools in Haskell: expand</h1>
<!-- BEGIN BODY -->
<h2>uncompress text on stdin (run length encoding)</h2>

<div class="info">
Posted on 2016-02-24 by nbloomf
</div>


<div class="info tags">Tags: <a href="../../tag/software-tools-in-haskell.html">software-tools-in-haskell</a>, <a href="../../tag/literate-haskell.html">literate-haskell</a></div>


<p>This page is part of a series on <a href="../../pages/sth/index.html">Software Tools in Haskell</a>.</p>

<p>This post is literate Haskell; you can load <a href="https://raw.githubusercontent.com/nbloomf/nbloomf.md/master/posts/software-tools-in-haskell/expand.lhs">the source</a> into GHCi and play along.</p>

<p>As usual, we start with some imports.</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="co">-- sth-expand: uncompress stdin (run length encoding)</span>
<span class="ot">&gt;</span> <span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Exit</span> (exitSuccess, exitFailure)
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.IO</span> (hPutStrLn, stderr)
<span class="ot">&gt;</span> <span class="kw">import </span><span class="dt">System.Environment</span> (getProgName)</code></pre></div>
<p>The companion to <a href="../../posts/2016-02-23-software-tools-in-haskell-compress.html"><code>compress</code></a> is <code>expand</code>. It reads a string of characters that was run length encoded by <code>compress</code> and uncompresses it. This program has an error condition; the input may not be valid. This can happen for a few reasons; if a repeat count is incorrectly encoded (i.e. includes invalid digits or does not terminate in a sigil), or if the file ends in the middle of a repeat encoding.</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; main ::</span> <span class="dt">IO</span> ()
<span class="ot">&gt;</span> main <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   xs <span class="ot">&lt;-</span> getContents
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>   ys <span class="ot">&lt;-</span> <span class="kw">case</span> rlDecode <span class="ch">'\BEL'</span> xs <span class="kw">of</span>
<span class="ot">&gt;</span>           <span class="dt">Just</span> zs <span class="ot">-&gt;</span> return zs
<span class="ot">&gt;</span>           <span class="dt">Nothing</span> <span class="ot">-&gt;</span> reportErrorMsgs
<span class="ot">&gt;</span>                        [ <span class="st">&quot;corrupt input&quot;</span>
<span class="ot">&gt;</span>                        ] <span class="fu">&gt;&gt;</span> exitFailure
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span>   putStr ys
<span class="ot">&gt;</span>   exitSuccess</code></pre></div>
<p><code>rlDecode</code> does all the work:</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; rlDecode ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span>
<span class="ot">&gt;</span> rlDecode sig <span class="fu">=</span> fmap (runLengthDecode sig) <span class="fu">.</span> readRLE sig
<span class="ot">&gt;</span>   <span class="kw">where</span>
<span class="ot">&gt;     runLengthDecode ::</span> (<span class="dt">Eq</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> [<span class="dt">RLE</span> a] <span class="ot">-&gt;</span> [a]
<span class="ot">&gt;</span>     runLengthDecode sig <span class="fu">=</span> concatMap decodeRLE
<span class="ot">&gt;</span>       <span class="kw">where</span>
<span class="ot">&gt;</span>         decodeRLE (<span class="dt">Chunk</span>  xs)  <span class="fu">=</span> xs
<span class="ot">&gt;</span>         decodeRLE (<span class="dt">Repeat</span> k x) <span class="fu">=</span> replicate k x
<span class="ot">&gt;</span>         decodeRLE (<span class="dt">Literal</span> k)  <span class="fu">=</span> replicate k sig
<span class="ot">&gt;</span> 
<span class="ot">&gt;     readRLE ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">RLE</span> <span class="dt">Char</span>]
<span class="ot">&gt;</span>     readRLE sig <span class="fu">=</span> unfoldrMaybe readFirstRLE
<span class="ot">&gt;</span>       <span class="kw">where</span>
<span class="ot">&gt;         readFirstRLE ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Maybe</span> (<span class="dt">RLE</span> <span class="dt">Char</span>, <span class="dt">String</span>))
<span class="ot">&gt;</span>         readFirstRLE <span class="st">&quot;&quot;</span>  <span class="fu">=</span> <span class="dt">Just</span> <span class="dt">Nothing</span>
<span class="ot">&gt;</span>         readFirstRLE [x] <span class="fu">=</span>
<span class="ot">&gt;</span>           <span class="kw">if</span> x <span class="fu">==</span> sig <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Chunk</span> [x], <span class="st">&quot;&quot;</span>))
<span class="ot">&gt;</span>         readFirstRLE [x,y] <span class="fu">=</span>
<span class="ot">&gt;</span>           <span class="kw">if</span> x <span class="fu">==</span> sig <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Chunk</span> [x], [y]))
<span class="ot">&gt;</span>         readFirstRLE (x<span class="fu">:</span>y<span class="fu">:</span>z<span class="fu">:</span>xs)
<span class="ot">&gt;</span>           <span class="fu">|</span> x <span class="fu">==</span> sig <span class="fu">&amp;&amp;</span> y <span class="fu">==</span> sig <span class="fu">&amp;&amp;</span> z <span class="fu">==</span> sig
<span class="ot">&gt;</span>               <span class="fu">=</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Literal</span> <span class="dv">1</span>, xs))
<span class="ot">&gt;</span>           <span class="fu">|</span> x <span class="fu">==</span> sig <span class="fu">&amp;&amp;</span> y <span class="fu">==</span> sig <span class="fu">&amp;&amp;</span> z <span class="fu">/=</span> sig
<span class="ot">&gt;</span>               <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>                   <span class="kw">let</span> (as,bs) <span class="fu">=</span> span (<span class="fu">/=</span> sig) (z<span class="fu">:</span>xs)
<span class="ot">&gt;</span>                   k <span class="ot">&lt;-</span> readBase86Nat as
<span class="ot">&gt;</span>                   <span class="kw">case</span> bs <span class="kw">of</span>
<span class="ot">&gt;</span>                     <span class="st">&quot;&quot;</span>     <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Repeat</span> k y, <span class="st">&quot;&quot;</span>))
<span class="ot">&gt;</span>                     (_<span class="fu">:</span>cs) <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Repeat</span> k y, cs))
<span class="ot">&gt;</span>           <span class="fu">|</span> x <span class="fu">==</span> sig <span class="fu">&amp;&amp;</span> y <span class="fu">/=</span> sig
<span class="ot">&gt;</span>               <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>                   <span class="kw">let</span> (as,bs) <span class="fu">=</span> span (<span class="fu">/=</span> sig) (z<span class="fu">:</span>xs)
<span class="ot">&gt;</span>                   k <span class="ot">&lt;-</span> readBase86Nat as
<span class="ot">&gt;</span>                   <span class="kw">case</span> bs <span class="kw">of</span>
<span class="ot">&gt;</span>                     <span class="st">&quot;&quot;</span>     <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Repeat</span> k y, <span class="st">&quot;&quot;</span>))
<span class="ot">&gt;</span>                     (_<span class="fu">:</span>cs) <span class="ot">-&gt;</span> <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Repeat</span> k y, cs))
<span class="ot">&gt;</span>           <span class="fu">|</span> otherwise
<span class="ot">&gt;</span>               <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>                   <span class="kw">let</span> (as,bs) <span class="fu">=</span> span (<span class="fu">/=</span> sig) (x<span class="fu">:</span>y<span class="fu">:</span>z<span class="fu">:</span>xs)
<span class="ot">&gt;</span>                   <span class="dt">Just</span> (<span class="dt">Just</span> (<span class="dt">Chunk</span> as, bs))</code></pre></div>
<p><code>readBase86Nat</code> is the companion to <code>showBase86Nat</code>:</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt; readBase86Nat ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span>
<span class="ot">&gt;</span> readBase86Nat xs <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   ys <span class="ot">&lt;-</span> sequence <span class="fu">$</span> map charToInt <span class="fu">$</span> reverse xs
<span class="ot">&gt;</span>   return <span class="fu">$</span> sum <span class="fu">$</span> zipWith (<span class="fu">*</span>) ys [<span class="dv">86</span><span class="fu">^</span>t <span class="fu">|</span> t <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>]]
<span class="ot">&gt;</span>   <span class="kw">where</span>
<span class="ot">&gt;     charToInt ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span>
<span class="ot">&gt;</span>     charToInt x <span class="fu">=</span> lookup x
<span class="ot">&gt;</span>       [ (<span class="ch">'0'</span>,<span class="dv">0</span>),  (<span class="ch">'1'</span>,<span class="dv">1</span>),  (<span class="ch">'2'</span>,<span class="dv">2</span>),  (<span class="ch">'3'</span>,<span class="dv">3</span>),  (<span class="ch">'4'</span>,<span class="dv">4</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'5'</span>,<span class="dv">5</span>),  (<span class="ch">'6'</span>,<span class="dv">6</span>),  (<span class="ch">'7'</span>,<span class="dv">7</span>),  (<span class="ch">'8'</span>,<span class="dv">8</span>),  (<span class="ch">'9'</span>,<span class="dv">9</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'a'</span>,<span class="dv">10</span>), (<span class="ch">'b'</span>,<span class="dv">11</span>), (<span class="ch">'c'</span>,<span class="dv">12</span>), (<span class="ch">'d'</span>,<span class="dv">13</span>), (<span class="ch">'e'</span>,<span class="dv">14</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'f'</span>,<span class="dv">15</span>), (<span class="ch">'g'</span>,<span class="dv">16</span>), (<span class="ch">'h'</span>,<span class="dv">17</span>), (<span class="ch">'i'</span>,<span class="dv">18</span>), (<span class="ch">'j'</span>,<span class="dv">19</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'k'</span>,<span class="dv">20</span>), (<span class="ch">'l'</span>,<span class="dv">21</span>), (<span class="ch">'m'</span>,<span class="dv">22</span>), (<span class="ch">'n'</span>,<span class="dv">23</span>), (<span class="ch">'o'</span>,<span class="dv">24</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'p'</span>,<span class="dv">25</span>), (<span class="ch">'q'</span>,<span class="dv">26</span>), (<span class="ch">'r'</span>,<span class="dv">27</span>), (<span class="ch">'s'</span>,<span class="dv">28</span>), (<span class="ch">'t'</span>,<span class="dv">29</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'u'</span>,<span class="dv">30</span>), (<span class="ch">'v'</span>,<span class="dv">31</span>), (<span class="ch">'w'</span>,<span class="dv">32</span>), (<span class="ch">'x'</span>,<span class="dv">33</span>), (<span class="ch">'y'</span>,<span class="dv">34</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'z'</span>,<span class="dv">35</span>), (<span class="ch">'A'</span>,<span class="dv">36</span>), (<span class="ch">'B'</span>,<span class="dv">37</span>), (<span class="ch">'C'</span>,<span class="dv">38</span>), (<span class="ch">'D'</span>,<span class="dv">39</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'E'</span>,<span class="dv">40</span>), (<span class="ch">'F'</span>,<span class="dv">41</span>), (<span class="ch">'G'</span>,<span class="dv">42</span>), (<span class="ch">'H'</span>,<span class="dv">43</span>), (<span class="ch">'I'</span>,<span class="dv">44</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'J'</span>,<span class="dv">45</span>), (<span class="ch">'K'</span>,<span class="dv">46</span>), (<span class="ch">'L'</span>,<span class="dv">47</span>), (<span class="ch">'M'</span>,<span class="dv">48</span>), (<span class="ch">'N'</span>,<span class="dv">49</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'O'</span>,<span class="dv">50</span>), (<span class="ch">'P'</span>,<span class="dv">51</span>), (<span class="ch">'Q'</span>,<span class="dv">52</span>), (<span class="ch">'R'</span>,<span class="dv">53</span>), (<span class="ch">'S'</span>,<span class="dv">54</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'T'</span>,<span class="dv">55</span>), (<span class="ch">'U'</span>,<span class="dv">56</span>), (<span class="ch">'V'</span>,<span class="dv">57</span>), (<span class="ch">'W'</span>,<span class="dv">58</span>), (<span class="ch">'X'</span>,<span class="dv">59</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'Y'</span>,<span class="dv">60</span>), (<span class="ch">'Z'</span>,<span class="dv">61</span>), (<span class="ch">'?'</span>,<span class="dv">62</span>), (<span class="ch">'!'</span>,<span class="dv">63</span>), (<span class="ch">'#'</span>,<span class="dv">64</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'&amp;'</span>,<span class="dv">65</span>), (<span class="ch">'@'</span>,<span class="dv">66</span>), (<span class="ch">'$'</span>,<span class="dv">67</span>), (<span class="ch">'='</span>,<span class="dv">68</span>), (<span class="ch">'+'</span>,<span class="dv">69</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'-'</span>,<span class="dv">70</span>), (<span class="ch">'~'</span>,<span class="dv">71</span>), (<span class="ch">'&lt;'</span>,<span class="dv">72</span>), (<span class="ch">'&gt;'</span>,<span class="dv">73</span>), (<span class="ch">'['</span>,<span class="dv">74</span>)
<span class="ot">&gt;</span>       , (<span class="ch">']'</span>,<span class="dv">75</span>), (<span class="ch">'('</span>,<span class="dv">76</span>), (<span class="ch">')'</span>,<span class="dv">77</span>), (<span class="ch">'{'</span>,<span class="dv">78</span>), (<span class="ch">'}'</span>,<span class="dv">79</span>)
<span class="ot">&gt;</span>       , (<span class="ch">'|'</span>,<span class="dv">80</span>), (<span class="ch">'/'</span>,<span class="dv">81</span>), (<span class="ch">'*'</span>,<span class="dv">82</span>), (<span class="ch">'^'</span>,<span class="dv">83</span>), (<span class="ch">':'</span>,<span class="dv">84</span>)
<span class="ot">&gt;</span>       , (<span class="ch">';'</span>,<span class="dv">85</span>)
<span class="ot">&gt;</span>       ]</code></pre></div>
<p>One big improvement we could make to <code>expand</code> is to try to handle invalid input more gracefully; we could output the partially expanded text, for instance, or tell the user exactly where the error occurs. The first idea would not be too difficult. (Write the output to stderr.) The second idea, though, while possibly useful, would make the implementation much more complicated. (We’d have to keep track of the position of each character in the original source.) Doable, but until the need is demonstrated I’d prefer to keep the implementation simple.</p>
<p>Old stuff:</p>
<div class="sourceCode"><pre class="sourceCode literate literatehaskell"><code class="sourceCode literatehaskell"><span class="ot">&gt;</span> <span class="co">-- apply a map to stdin</span>
<span class="ot">&gt; charFilter ::</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
<span class="ot">&gt;</span> charFilter f <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   xs <span class="ot">&lt;-</span> getContents
<span class="ot">&gt;</span>   putStr <span class="fu">$</span> f xs
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> <span class="co">-- run length encoding</span>
<span class="ot">&gt;</span> <span class="kw">data</span> <span class="dt">RLE</span> a
<span class="ot">&gt;</span>   <span class="fu">=</span> <span class="dt">Chunk</span>   [a]
<span class="ot">&gt;</span>   <span class="fu">|</span> <span class="dt">Repeat</span>  <span class="dt">Int</span> a
<span class="ot">&gt;</span>   <span class="fu">|</span> <span class="dt">Literal</span> <span class="dt">Int</span>
<span class="ot">&gt;</span>   <span class="kw">deriving</span> <span class="dt">Show</span>
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt; unfoldrMaybe ::</span> (b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Maybe</span> (a,b))) <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [a]
<span class="ot">&gt;</span> unfoldrMaybe f x <span class="fu">=</span> <span class="kw">case</span> f x <span class="kw">of</span>
<span class="ot">&gt;</span>   <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span>
<span class="ot">&gt;</span>   <span class="dt">Just</span> <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> []
<span class="ot">&gt;</span>   <span class="dt">Just</span> (<span class="dt">Just</span> (a,b)) <span class="ot">-&gt;</span> <span class="kw">do</span>
<span class="ot">&gt;</span>     as <span class="ot">&lt;-</span> unfoldrMaybe f b
<span class="ot">&gt;</span>     <span class="dt">Just</span> (a<span class="fu">:</span>as)
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt; digitsToBase ::</span> (<span class="dt">Integral</span> n) <span class="ot">=&gt;</span> n <span class="ot">-&gt;</span> n <span class="ot">-&gt;</span> [n]
<span class="ot">&gt;</span> digitsToBase b k
<span class="ot">&gt;</span>   <span class="fu">|</span> b <span class="fu">&lt;=</span> <span class="dv">1</span> <span class="fu">||</span> k <span class="fu">&lt;=</span> <span class="dv">0</span> <span class="fu">=</span> []
<span class="ot">&gt;</span>   <span class="fu">|</span> otherwise <span class="fu">=</span> reverse <span class="fu">$</span> foo k
<span class="ot">&gt;</span>       <span class="kw">where</span>
<span class="ot">&gt;</span>         foo t
<span class="ot">&gt;</span>           <span class="fu">|</span> t <span class="fu">&lt;</span> b <span class="fu">=</span> [t]
<span class="ot">&gt;</span>           <span class="fu">|</span> otherwise <span class="fu">=</span> (t<span class="ot">`rem`</span>b) <span class="fu">:</span> (foo (t<span class="ot">`quot`</span>b))
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> 
<span class="ot">&gt;</span> <span class="co">-- write list of messages to stderr</span>
<span class="ot">&gt; reportErrorMsgs ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
<span class="ot">&gt;</span> reportErrorMsgs errs <span class="fu">=</span> <span class="kw">do</span>
<span class="ot">&gt;</span>   name <span class="ot">&lt;-</span> getProgName
<span class="ot">&gt;</span>   sequence_ <span class="fu">$</span> map (hPutStrLn stderr) <span class="fu">$</span> ((name <span class="fu">++</span> <span class="st">&quot; error&quot;</span>)<span class="fu">:</span>errs)</code></pre></div>

<!-- END BODY -->
</div>

<div id="footer">
  Site generated by
  <a href="http://jaspervdj.be/hakyll">Hakyll</a>
</div>
</body>
</html>
